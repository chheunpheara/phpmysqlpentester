<?php

namespace controller;

class UserController {
    
    private $userModel;

    private $method = 'GET';

    public function __construct() {
        $this->userModel = new \model\UserModel;
        $this->method = $_SERVER['REQUEST_METHOD'];
    }

    public function register() {
        if ($this->method == 'GET') {
            $html = "<form method=\"POST\">";
            $html .= "<p><h3>Register</h3></p>";
            $html .= "<p><label for=\"username\">Username</label> <input type=\"text\" name=\"username\"></p>";
            $html .= "<p><label for=\"password\">Password</label> <input type=\"password\" name=\"password\"></p>";
            $html .= "<p><label for=\"re-password\">Repeat password</label> <input type=\"password\" name=\"re_password\"></p>";
            $html .= "<p><input type=\"submit\" value=\"Register\"></p>";
            $html .= "</form>";
            $html .= "<a href=\"?page=user&route=login\">Login</a>";
            echo $html;
            return;
        }

        $username = $_POST['username'];
        $password = $_POST['password'];
        $repassword = $_POST['re_password'];
        if ($password !== $repassword) die('Password does not match!');
        if (\strlen($username) == 0 || strlen($password) == 0 || strlen($repassword) == 0) die('Username or password required');

        $created = $this->userModel->register([
            'username' => $username,
            'password' => $password
        ]);

        if ($created) {
            die('Create success');
        }

        die('Unable to create new user');
    }

    public function login() {
        if ($this->method == 'GET') {
            echo 'Break this login by SQL Injection';
            echo "<pre>' or 1=1--<br>SELECT COUNT(*) as total FROM users WHERE username = '' or 1=1--' AND password = '''</pre>";
            echo "<pre>SELECT COUNT(*) as total FROM users WHERE username = 'admin' AND password = '' or 1=1--''</pre>";
            $html = "<form method=\"POST\">";
            $html .= "<p><h3>Login</h3></p>";
            $html .= "<p><label for=\"username\">Username</label> <input type=\"text\" name=\"username\"></p>";
            $html .= "<p><label for=\"password\">Password</label> <input type=\"password\" name=\"password\"></p>";
            $html .= "<p><input type=\"submit\" value=\"Login\"></p>";
            $html .= "</form>";
            $html .= "No account? <a href=\"?page=user&route=register\">Register</a>";
            echo $html;
            return;
        }

        $username = $_POST['username'];
        $password = $_POST['password'];
        // Break by sql injection no md5: SELECT COUNT(*) as total FROM users WHERE username = 'admin' AND password = '' or 1=1--''
        // Or: SELECT COUNT(*) as total FROM users WHERE username = '' or 1=1--' AND password = '''

        $login = $this->userModel->login(
            [
                'username' => $username,
                'password' => $password
            ]
        );

        if ($login) {
            echo 'Login success...';
        } else {
            echo 'Failed to login!';
        }
    }

    public function logout() {
        echo 'Logout page';
    }
}